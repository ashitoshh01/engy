
<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock News Agent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {"50":"#eff6ff","100":"#dbeafe","200":"#bfdbfe","300":"#93c5fd","400":"#60a5fa","500":"#3b82f6","600":"#2563eb","700":"#1d4ed8","800":"#1e40af","900":"#1e3a8a","950":"#172554"}
                    }
                },
                fontFamily: {
                    'body': [
                        'Inter', 
                        'ui-sans-serif', 
                        'system-ui', 
                        '-apple-system', 
                        'system-ui', 
                        'Segoe UI', 
                        'Roboto', 
                        'Helvetica Neue', 
                        'Arial', 
                        'Noto Sans', 
                        'sans-serif', 
                        'Apple Color Emoji', 
                        'Segoe UI Emoji', 
                        'Segoe UI Symbol', 
                        'Noto Color Emoji'
                    ],
                    'sans': [
                        'Inter', 
                        'ui-sans-serif', 
                        'system-ui', 
                        '-apple-system', 
                        'system-ui', 
                        'Segoe UI', 
                        'Roboto', 
                        'Helvetica Neue', 
                        'Arial', 
                        'Noto Sans', 
                        'sans-serif', 
                        'Apple Color Emoji', 
                        'Segoe UI Emoji', 
                        'Segoe UI Symbol', 
                        'Noto Color Emoji'
                    ]
                }
            }
        }
    </script>
</head>
<body class="h-full font-sans antialiased">
    <div class="min-h-full">
        <nav class="bg-gray-800">
            <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
                <div class="flex h-16 items-center justify-between">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <img class="h-8 w-8" src="https://tailwindui.com/img/logos/mark.svg?color=indigo&shade=500" alt="Your Company">
                        </div>
                        <div class="ml-10 flex items-baseline space-x-4">
                            <a href="#" class="bg-gray-900 text-white rounded-md px-3 py-2 text-sm font-medium" aria-current="page">Stock News Agent</a>
                        </div>
                    </div>
                    <div class="ml-4 flex items-center md:ml-6">
                        <button type="button" id="darkModeToggle" class="rounded-full bg-gray-800 p-1 text-gray-400 hover:text-white focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2 focus:ring-offset-gray-800">
                            <span class="sr-only">Toggle dark mode</span>
                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <header class="bg-white shadow dark:bg-gray-700">
            <div class="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8">
                <h1 class="text-3xl font-bold tracking-tight text-gray-900 dark:text-white">Stock News Agent</h1>
            </div>
        </header>

        <main>
            <div class="mx-auto max-w-7xl py-6 sm:px-6 lg:px-8">
                <div class="px-4 py-6 sm:px-0">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6 space-y-4 md:space-y-0">
                        <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                            <input type="text" id="companySymbol" placeholder="Enter company symbol" class="rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white" aria-label="Company Symbol">
                            <button id="runButton" class="inline-flex justify-center rounded-md border border-transparent bg-indigo-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">Run Agent</button>
                            <button id="stopButton" disabled class="inline-flex justify-center rounded-md border border-transparent bg-red-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">Stop Agent</button>
                        </div>
                        <div class="flex space-x-4">
                            <input type="text" id="searchInput" placeholder="Search news" class="rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white" aria-label="Search news">
                            <button id="refreshButton" class="inline-flex justify-center rounded-md border border-transparent bg-green-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                                <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                Refresh
                            </button>
                        </div>
                    </div>

                    <!-- Agent Status Section -->
                    <div id="agentStatus" class="mb-6 p-4 bg-white rounded-lg shadow dark:bg-gray-800">
                        <h2 class="text-xl font-semibold mb-2 text-gray-900 dark:text-white">Agent Status</h2>
                        <p id="statusText" class="text-gray-600 dark:text-gray-300">Status: Idle</p>
                        <p id="companyText" class="text-gray-600 dark:text-gray-300">Company: N/A</p>
                        <div class="mt-2">
                            <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700">
                                <div id="progressBar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>
                        <p id="nextRunText" class="mt-2 text-gray-600 dark:text-gray-300">Next run: N/A</p>
                    </div>

                    <div class="overflow-x-auto rounded-lg shadow">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-800">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-400 cursor-pointer" data-sort="timestamp">Timestamp</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-400 cursor-pointer" data-sort="title">Title</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-400 cursor-pointer" data-sort="source">Source</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-400 cursor-pointer" data-sort="sentiment">Sentiment</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-400">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="newsTable" class="bg-white divide-y divide-gray-200 dark:bg-gray-900 dark:divide-gray-700">
                                <!-- Table rows will be dynamically inserted here -->
                            </tbody>
                        </table>
                    </div>
                    <div class="flex justify-center mt-4 space-x-2">
                        <button id="prevPage" disabled class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-indigo-700 bg-indigo-100 hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 dark:text-indigo-200 dark:bg-indigo-800 dark:hover:bg-indigo-700">Previous</button>
                        <span id="currentPage" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white dark:text-gray-200 dark:bg-gray-800">1</span>
                        <button id="nextPage" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-indigo-700 bg-indigo-100 hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 dark:text-indigo-200 dark:bg-indigo-800 dark:hover:bg-indigo-700">Next</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="toast" class="fixed top-5 right-5 bg-indigo-600 text-white px-4 py-2 rounded-md shadow-lg transition-opacity duration-300 opacity-0" role="alert" aria-live="assertive" aria-atomic="true"></div>

    <div id="modal" class="fixed z-10 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full dark:bg-gray-800">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4 dark:bg-gray-800">
                    <div class="sm:flex sm:items-start">
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white" id="modalTitle"></h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500 dark:text-gray-400" id="modalContent"></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse dark:bg-gray-700">
                    <button type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm dark:bg-gray-600 dark:text-white dark:hover:bg-gray-500" onclick="document.getElementById('modal').classList.add('hidden')">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div id="updateIndicator" class="fixed bottom-5 right-5 bg-indigo-600 text-white p-2 rounded-full shadow-lg cursor-pointer hidden" title="New updates available">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
    </div>

    <script>
        const API_URL = 'http://localhost:7594';
        let currentPage = 1;
        let isAgentRunning = false;
        let sortColumn = 'timestamp';
        let sortOrder = 'desc';

        const runButton = document.getElementById('runButton');
        const stopButton = document.getElementById('stopButton');
        const refreshButton = document.getElementById('refreshButton');
        const companySymbolInput = document.getElementById('companySymbol');
        const searchInput = document.getElementById('searchInput');
        const newsTable = document.getElementById('newsTable');
        const prevPageButton = document.getElementById('prevPage');
        const nextPageButton = document.getElementById('nextPage');
        const currentPageSpan = document.getElementById('currentPage');
        const toast = document.getElementById('toast');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modalTitle');
        const modalContent = document.getElementById('modalContent');
        const updateIndicator = document.getElementById('updateIndicator');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const statusText = document.getElementById('statusText');
        const companyText = document.getElementById('companyText');
        const progressBar = document.getElementById('progressBar');
        const nextRunText = document.getElementById('nextRunText');

        runButton.addEventListener('click', runAgent);
        stopButton.addEventListener('click', stopAgent);
        refreshButton.addEventListener('click', fetchNews);
        searchInput.addEventListener('input', debounce(fetchNews, 300));
        prevPageButton.addEventListener('click', () => changePage(-1));
        nextPageButton.addEventListener('click', () => changePage(1));
        updateIndicator.addEventListener('click', () => {
            fetchNews();
            updateIndicator.classList.add('hidden');
            lastUpdateTime = new Date();
        });
        darkModeToggle.addEventListener('click', toggleDarkMode);

        document.querySelector('thead').addEventListener('click', (e) => {
            const th = e.target.closest('th');
            if (th && th.dataset.sort) {
                const newSortColumn = th.dataset.sort;
                if (newSortColumn === sortColumn) {
                    sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
                } else {
                    sortColumn = newSortColumn;
                    sortOrder = 'asc';
                }
                fetchNews();
            }
        });

        function runAgent() {
            const companySymbol = companySymbolInput.value.trim();
            if (!companySymbol) {
                showToast('Please enter a company symbol');
                return;
            }
            fetch(`${API_URL}/run`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ company_symbol: companySymbol })
            })
            .then(response => response.json())
            .then(data => {
                showToast(data.message);
                isAgentRunning = true;
                runButton.disabled = true;
                stopButton.disabled = false;
                startPolling();
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Failed to start the agent');
            });
        }

        function stopAgent() {
            fetch(`${API_URL}/stop`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                showToast(data.message);
                isAgentRunning = false;
                runButton.disabled = false;
                stopButton.disabled = true;
                stopPolling();
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Failed to stop the agent');
            });
        }

        function fetchNews() {
            const searchTerm = searchInput.value.trim();
            fetch(`${API_URL}/news?page=${currentPage}&search=${searchTerm}&sort=${sortColumn}&order=${sortOrder}`)
            .then(response => response.json())
            .then(data => {
                updateNewsTable(data);
                updatePagination(data);
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Failed to fetch news');
            });
        }

        function updateNewsTable(data) {
            newsTable.innerHTML = '';
            data.forEach(entry => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-100 dark:hover:bg-gray-700';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${new Date(entry.timestamp).toLocaleString()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">${entry.title}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${entry.source}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${entry.sentiment}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="showDetails('${entry.id}')" class="text-indigo-600 hover:text-indigo-900 dark:text-indigo-400 dark:hover:text-indigo-300">Details</button>
                    </td>
                `;
                newsTable.appendChild(row);
            });
        }

        function updatePagination(data) {
            prevPageButton.disabled = currentPage === 1;
            nextPageButton.disabled = data.length < 10;
            currentPageSpan.textContent = currentPage;
        }

        function changePage(delta) {
            currentPage += delta;
            fetchNews();
        }

        function showDetails(id) {
            fetch(`${API_URL}/news/${id}`)
            .then(response => response.json())
            .then(data => {
                modalTitle.textContent = data.title;
                modalContent.textContent = data.content;
                modal.classList.remove('hidden');
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Failed to fetch news details');
            });
        }

        function showToast(message) {
            toast.textContent = message;
            toast.classList.remove('opacity-0');
            setTimeout(() => {
                toast.classList.add('opacity-0');
            }, 3000);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        let pollingInterval;

        function startPolling() {
            pollingInterval = setInterval(() => {
                if (isAgentRunning) {
                    checkAgentStatus();
                }
            }, 5000); // Check every 5 seconds
        }

        function stopPolling() {
            clearInterval(pollingInterval);
        }

        function checkAgentStatus() {
            fetch(`${API_URL}/status`)
            .then(response => response.json())
            .then(data => {
                updateAgentStatus(data);
            })
            .catch(error => console.error('Error checking agent status:', error));
        }

        function updateAgentStatus(data) {
            statusText.textContent = `Status: ${data.status}`;
            companyText.textContent = `Company: ${data.company_symbol || 'N/A'}`;
            progressBar.style.width = `${data.progress}%`;
            nextRunText.textContent = `Next run: ${data.next_run_time ? new Date(data.next_run_time).toLocaleString() : 'N/A'}`;
            
            if (data.running) {
                runButton.disabled = true;
                stopButton.disabled = false;
            } else {
                runButton.disabled = false;
                stopButton.disabled = true;
            }
        }

        let lastUpdateTime = new Date();

        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
        }

        // Initial news fetch and status check
        fetchNews();
        checkAgentStatus();
    </script>
</body>
</html>
