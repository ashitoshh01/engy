
<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Agent Workflow Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsPlumb/2.15.6/js/jsplumb.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.socket.io/4.4.1/socket.io.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .agent-node {
            width: 180px;
            height: 100px;
            position: absolute;
            transition: box-shadow 0.3s ease;
        }
        .agent-node:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        #workflow {
            height: 600px;
            position: relative;
        }
        .jtk-connector {
            z-index: 4;
        }
        .jtk-endpoint {
            z-index: 5;
        }
        .jtk-overlay {
            z-index: 6;
        }
    </style>
</head>
<body class="h-full">
    <div id="app" class="min-h-full">
        <nav class="bg-gray-800">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <img class="h-8 w-8" src="https://tailwindui.com/img/logos/workflow-mark-indigo-500.svg" alt="Workflow">
                        </div>
                        <div class="ml-10 flex items-baseline space-x-4">
                            <a href="#" class="bg-gray-900 text-white px-3 py-2 rounded-md text-sm font-medium">Dashboard</a>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <header class="bg-white shadow">
            <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
                <h1 class="text-3xl font-bold text-gray-900">Multi-Agent Workflow Dashboard</h1>
            </div>
        </header>

        <main>
            <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
                <div class="px-4 py-6 sm:px-0">
                    <div class="mb-6">
                        <label for="userInput" class="block text-sm font-medium text-gray-700">Input for the first agent</label>
                        <div class="mt-1 flex rounded-md shadow-sm">
                            <input type="text" name="userInput" id="userInput" v-model="userInput" class="flex-1 min-w-0 block w-full px-3 py-2 rounded-none rounded-l-md focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm border-gray-300" placeholder="Enter input here">
                            <button @click="startWorkflow" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-r-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                Start Workflow
                            </button>
                        </div>
                    </div>

                    <div id="workflow" class="border-4 border-dashed border-gray-200 rounded-lg mb-6"></div>

                    <div v-if="selectedAgent" class="bg-white shadow overflow-hidden sm:rounded-lg mb-6">
                        <div class="px-4 py-5 sm:px-6">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">{{ selectedAgent.name }}</h3>
                            <p class="mt-1 max-w-2xl text-sm text-gray-500">Agent Details</p>
                        </div>
                        <div class="border-t border-gray-200 px-4 py-5 sm:p-0">
                            <dl class="sm:divide-y sm:divide-gray-200">
                                <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                    <dt class="text-sm font-medium text-gray-500">Role</dt>
                                    <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">{{ selectedAgent.role }}</dd>
                                </div>
                                <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                    <dt class="text-sm font-medium text-gray-500">Goal</dt>
                                    <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">{{ selectedAgent.goal }}</dd>
                                </div>
                                <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                    <dt class="text-sm font-medium text-gray-500">Backstory</dt>
                                    <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">{{ selectedAgent.backstory }}</dd>
                                </div>
                                <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                                    <dt class="text-sm font-medium text-gray-500">Task Description</dt>
                                    <dd class="mt-1 text-sm text-gray-900 sm:mt-0 sm:col-span-2">{{ selectedAgent.task_description }}</dd>
                                </div>
                            </dl>
                        </div>
                    </div>

                    <div v-for="agent in agents" :key="agent.name" class="bg-white shadow overflow-hidden sm:rounded-lg mb-6">
                        <div class="px-4 py-5 sm:px-6 flex justify-between items-center">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">{{ agent.name }} Results</h3>
                            <button @click="toggleResults(agent.name)" class="inline-flex items-center px-2.5 py-1.5 border border-transparent text-xs font-medium rounded text-indigo-700 bg-indigo-100 hover:bg-indigo-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                                {{ resultsCollapsed[agent.name] ? 'Expand' : 'Collapse' }}
                            </button>
                        </div>
                        <div v-if="!resultsCollapsed[agent.name]" class="border-t border-gray-200 px-4 py-5 sm:p-0">
                            <div class="sm:p-6">
                                <div v-html="renderMarkdown(executionResults[agent.name])" class="prose max-w-none"></div>
                                <pre class="mt-4 bg-gray-50 rounded p-4 overflow-x-auto"><code>{{ JSON.stringify(JSON.parse(executionResults[agent.name] || '{}'), null, 2) }}</code></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        new Vue({
            el: '#app',
            data: {
                agents: [],
                selectedAgent: null,
                jsPlumbInstance: null,
                executionResults: {},
                resultsCollapsed: {},
                userInput: '',
                socket: null
            },
            mounted() {
                this.fetchAgents();
                this.initializeJsPlumb();
                this.connectWebSocket();
            },
            methods: {
                async fetchAgents() {
                    try {
                        const response = await axios.get('http://localhost:6092/api/agents');
                        this.agents = response.data;
                        this.agents.forEach(agent => {
                            this.resultsCollapsed[agent.name] = true;
                        });
                        this.$nextTick(() => {
                            this.createWorkflow();
                        });
                    } catch (error) {
                        console.error('Error fetching agents:', error);
                    }
                },
                initializeJsPlumb() {
                    this.jsPlumbInstance = jsPlumb.getInstance({
                        Connector: ["Bezier", { curviness: 50 }],
                        Anchors: ["Right", "Left"],
                        Endpoint: ["Dot", { radius: 4 }],
                        PaintStyle: { stroke: "#6366F1", strokeWidth: 2 },
                        HoverPaintStyle: { stroke: "#4F46E5" },
                        EndpointStyle: { fill: "#6366F1" },
                        EndpointHoverStyle: { fill: "#4F46E5" }
                    });
                },
                createWorkflow() {
                    const workflow = document.getElementById('workflow');
                    this.agents.forEach((agent, index) => {
                        const node = document.createElement('div');
                        node.id = agent.name;
                        node.className = 'agent-node bg-white rounded-lg shadow p-4 flex items-center justify-center text-center';
                        node.innerHTML = `<span class="font-medium text-gray-900">${agent.name}</span>`;
                        node.style.left = `${(index % 3) * 250 + 50}px`;
                        node.style.top = `${Math.floor(index / 3) * 150 + 50}px`;
                        workflow.appendChild(node);

                        node.addEventListener('click', () => {
                            this.selectedAgent = agent;
                        });

                        this.jsPlumbInstance.draggable(node);
                    });

                    this.agents.forEach(agent => {
                        agent.send_to.forEach(target => {
                            this.jsPlumbInstance.connect({
                                source: agent.name,
                                target: target,
                                overlays: [
                                    ["Arrow", { width: 10, length: 10, location: 1 }]
                                ]
                            });
                        });
                    });
                },
                connectWebSocket() {
                    this.socket = io('http://localhost:6092');
                    this.socket.on('connect', () => {
                        console.log('Connected to WebSocket');
                        this.socket.emit('subscribe_status');
                        this.socket.emit('subscribe_results');
                    });
                    this.socket.on('status_update', (data) => {
                        console.log('Status update:', data);
                    });
                    this.socket.on('execution_result', (data) => {
                        console.log('Execution result:', data);
                        this.executionResults[data.agent] = data.result;
                        this.$forceUpdate();
                        this.triggerDownstreamAgents(data.agent);
                    });
                },
                async executeAgent(agentName) {
                    try {
                        await axios.post(`http://localhost:6092/api/execute/${agentName}`);
                    } catch (error) {
                        console.error(`Error executing agent ${agentName}:`, error);
                    }
                },
                triggerDownstreamAgents(agentName) {
                    const agent = this.agents.find(a => a.name === agentName);
                    if (agent) {
                        agent.send_to.forEach(targetAgent => {
                            this.executeAgent(targetAgent);
                        });
                    }
                },
                toggleResults(agentName) {
                    this.resultsCollapsed[agentName] = !this.resultsCollapsed[agentName];
                },
                renderMarkdown(text) {
                    return text ? marked(text) : '';
                },
                startWorkflow() {
                    const firstAgent = this.agents.find(agent => agent.receive_from.length === 0);
                    if (firstAgent) {
                        this.executionResults[firstAgent.name] = this.userInput;
                        this.executeAgent(firstAgent.name);
                    }
                }
            }
        });
    </script>
</body>
</html>
