
<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Workflow Visualization</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .node {
            cursor: pointer;
        }
        .node circle {
            fill: #fff;
            stroke: #4a5568;
            stroke-width: 2px;
        }
        .node text {
            font-size: 12px;
            font-weight: 500;
        }
        .link {
            fill: none;
            stroke: #cbd5e0;
            stroke-opacity: 0.6;
            stroke-width: 2px;
        }
    </style>
</head>
<body class="h-full">
    <div class="min-h-full">
        <nav class="bg-gray-800">
            <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
                <div class="flex h-16 items-center justify-between">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <img class="h-8 w-8" src="https://tailwindui.com/img/logos/mark.svg?color=indigo&shade=500" alt="Your Company">
                        </div>
                        <div class="ml-10 flex items-baseline space-x-4">
                            <a href="#" class="bg-gray-900 text-white rounded-md px-3 py-2 text-sm font-medium">Agent Workflow</a>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <header class="bg-white shadow">
            <div class="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8">
                <h1 class="text-3xl font-bold tracking-tight text-gray-900">Agent Workflow Visualization</h1>
            </div>
        </header>

        <main>
            <div class="mx-auto max-w-7xl py-6 sm:px-6 lg:px-8">
                <div class="flex flex-col lg:flex-row">
                    <div id="graph" class="w-full lg:w-2/3 bg-white shadow-xl rounded-lg mb-6 lg:mb-0 lg:mr-6"></div>
                    <div class="w-full lg:w-1/3 space-y-6">
                        <div class="bg-white shadow-xl rounded-lg p-6">
                            <h2 class="text-xl font-semibold mb-4">Agent Status</h2>
                            <div id="status-container" class="space-y-2"></div>
                        </div>
                        <div class="bg-white shadow-xl rounded-lg p-6">
                            <h2 class="text-xl font-semibold mb-4">Execution Results</h2>
                            <div id="results-container" class="space-y-4"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal -->
    <div id="agentModal" class="fixed z-10 inset-0 overflow-y-auto hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true"></div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                                Agent Details
                            </h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500" id="modal-content"></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" id="closeModal" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = io('http://localhost:8314');
        let agents = [];

        // Fetch agent metadata
        fetch('/api/agents')
            .then(response => response.json())
            .then(data => {
                agents = data;
                createGraph();
            });

        function createGraph() {
            const graphElement = document.getElementById('graph');
            const width = graphElement.clientWidth;
            const height = 600;

            const svg = d3.select("#graph")
                .append("svg")
                .attr("width", width)
                .attr("height", height)
                .attr("viewBox", [0, 0, width, height])
                .attr("style", "max-width: 100%; height: auto;");

            const simulation = d3.forceSimulation(agents)
                .force("link", d3.forceLink().id(d => d.name).distance(150))
                .force("charge", d3.forceManyBody().strength(-1000))
                .force("center", d3.forceCenter(width / 2, height / 2));

            const links = [];
            agents.forEach(agent => {
                agent.send_to.forEach(target => {
                    links.push({source: agent.name, target: target});
                });
            });

            const link = svg.append("g")
                .selectAll("line")
                .data(links)
                .enter().append("line")
                .attr("class", "link");

            const node = svg.append("g")
                .selectAll(".node")
                .data(agents)
                .enter().append("g")
                .attr("class", "node")
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended));

            node.append("circle")
                .attr("r", 40)
                .attr("fill", "#EDF2F7")
                .attr("stroke", "#4A5568")
                .attr("stroke-width", 2);

            node.append("text")
                .attr("dy", ".35em")
                .attr("text-anchor", "middle")
                .text(d => d.name)
                .attr("fill", "#2D3748");

            node.append("title")
                .text(d => d.role);

            simulation
                .nodes(agents)
                .on("tick", ticked);

            simulation.force("link")
                .links(links);

            function ticked() {
                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                node
                    .attr("transform", d => `translate(${d.x},${d.y})`);
            }

            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }

            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }

            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }

            // Add click event to show agent metadata
            node.on("click", (event, d) => {
                showAgentMetadata(d);
            });
        }

        function showAgentMetadata(agent) {
            const modal = document.getElementById('agentModal');
            const modalContent = document.getElementById('modal-content');
            const closeModal = document.getElementById('closeModal');

            modalContent.innerHTML = `
                <p><strong>Name:</strong> ${agent.name}</p>
                <p><strong>Role:</strong> ${agent.role}</p>
                <p><strong>Send To:</strong> ${agent.send_to.join(', ') || 'None'}</p>
                <p><strong>Receive From:</strong> ${agent.receive_from.join(', ') || 'None'}</p>
            `;

            modal.classList.remove('hidden');

            closeModal.onclick = function() {
                modal.classList.add('hidden');
            }

            window.onclick = function(event) {
                if (event.target == modal) {
                    modal.classList.add('hidden');
                }
            }
        }

        // WebSocket event handlers
        socket.on('status_update', (data) => {
            updateStatus(data.agent, data.status);
        });

        socket.on('execution_result', (data) => {
            updateResult(data.agent, data.result);
        });

        function updateStatus(agent, status) {
            const statusContainer = document.getElementById('status-container');
            let statusElement = document.getElementById(`status-${agent}`);
            
            if (!statusElement) {
                statusElement = document.createElement('div');
                statusElement.id = `status-${agent}`;
                statusElement.classList.add('p-2', 'rounded');
                statusContainer.appendChild(statusElement);
            }

            statusElement.textContent = `${agent}: ${status}`;
            statusElement.className = 'p-2 rounded';
            if (status === 'Running') statusElement.classList.add('bg-blue-100', 'text-blue-800');
            if (status === 'Completed') statusElement.classList.add('bg-green-100', 'text-green-800');
            if (status.startsWith('Error')) statusElement.classList.add('bg-red-100', 'text-red-800');
        }

        function updateResult(agent, result) {
            const resultsContainer = document.getElementById('results-container');
            let resultElement = document.getElementById(`result-${agent}`);
            
            if (!resultElement) {
                resultElement = document.createElement('div');
                resultElement.id = `result-${agent}`;
                resultElement.classList.add('bg-gray-100', 'p-4', 'rounded');
                resultsContainer.appendChild(resultElement);
            }

            resultElement.innerHTML = `<strong class="font-semibold">${agent}:</strong><pre class="mt-2 text-sm overflow-x-auto">${JSON.stringify(JSON.parse(result), null, 2)}</pre>`;
        }

        // Subscribe to status updates and results
        socket.emit('subscribe_status');
        socket.emit('subscribe_results');
    </script>
</body>
</html>
